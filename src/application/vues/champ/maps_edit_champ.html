<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <style type="text/css">
                html, body { height: 100%; margin: 0; padding: 0; }
                #map { height: 100%; }
                .label {font-size:9px; text-align:center; color:#222; text-shadow:0 0 5px #fff; font-family:Helvetica, Arial, sans-serif;}
        </style>
    </head>
    <body>
        <div id="map"></div>

        <script type="text/javascript">
            var map;
            var polygon;

            function initMap() {
                var latLng = new google.maps.LatLng(47.970787, -1.448450); // Correspond au coordonnées de Les rivière, 35000 Janzé

                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15, // Zoom par défaut
                    center: latLng, // Coordonnées de départ de la carte de type latLng
                    streetViewControl: false, // On désactive le streetview
                    mapTypeId: google.maps.MapTypeId.ROADMAP // Type de carte ( HYBRID, ROADMAP, SATELLITE ou TERRAIN )
                });

                jsInterface.askToLoadChamps(); // On demande à Java de setup les champs

            }

            /** Ajouter un champ à la Map **/
            function addChamp(id, culture, proprio, adresse, surface, coords, couleur) {
                var path = [];
                var coordsParse = JSON.parse(coords);

                coordsParse.forEach(function(point){
                    var split = point.toString().split(",");
                    path.push(new google.maps.LatLng(split[0], split[1]));
                });

                polygon = new google.maps.Polygon({
                  paths: path,
                  id: id,
                  strokeWeight: 2,
                  strokeColor: couleur,
                  fillColor: couleur,
                  editable: true
                });

                polygon.setMap(map);
                map.setCenter(getPolygonCenter(polygon));

                polygon.addListener('rightclick', deleteNode);

                polygon.getPaths().forEach(function(path, index){
                    google.maps.event.addListener(path, 'insert_at', function(){
                        jsInterface.setPolygonEdited(toJavaArray(polygon));
                    });

                    google.maps.event.addListener(path, 'remove_at', function(){
                        jsInterface.setPolygonEdited(toJavaArray(polygon));
                    });

                    google.maps.event.addListener(path, 'set_at', function(){
                        jsInterface.setPolygonEdited(toJavaArray(polygon));
                    });
                });
            }

            function getPolygonCenter(polygon) {
                var bounds = new google.maps.LatLngBounds();
                var vertices = polygon.getPath();
                for (var i = 0; i < vertices.getLength(); i++) {
                    bounds.extend(vertices.getAt(i));
                }
                return bounds.getCenter();
            }

            function toJavaArray(polygon) {
                var javaArray = "[";

                var vertices = polygon.getPath();
                var length = vertices.getLength();

                vertices.forEach(function(xy, i) {
                    javaArray += "[" + xy.lat() + ',' + xy.lng() + "]";
                    if(i < length - 1)
                        javaArray += ",";
                });
                javaArray += "]";

                return javaArray;
            }

            var deleteNode = function deleteNode(mev) {
                if (mev.vertex != null) {
                    jsInterface.log("ok");
                    polygon.getPath().removeAt(mev.vertex);
                }
            }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbikGyg54hhQ7U_3qsCfOq9G3YV4jeWuk&callback=initMap" async defer></script>
    </body>
</html>